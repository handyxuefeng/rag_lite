{% extends "base.html" %}

{% block title %}
智能问答 - RAG Lite
{% endblock %}

{% block extra_css %}
<style>
    .chat-container {
        height: calc(100vh - 200px);
        display: flex;
        gap: 1rem;
    }

    .chat-sidebar {
        width: 280px;
        background: #fff;
        border-radius: 0.5rem;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        display: flex;
        flex-direction: column;
    }

    .chat-main {
        flex: 1;
        background: #fff;
        border-radius: 0.5rem;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        display: flex;
        flex-direction: column;
    }

    .session-list {
        flex: 1;
        overflow-y: auto;
        padding: 0.5rem;
    }

    .session-item {
        padding: 0.75rem;
        margin-bottom: 0.5rem;
        border-radius: 0.5rem;
        cursor: pointer;
        transition: background-color 0.2s;
        position: relative;
    }

    .session-item:hover {
        background-color: #f8f9fa;
    }

    .session-item.active {
        background-color: #e3f2fd;
        border-left: 3px solid #0d6efd;
    }

    .session-item .session-title {
        font-weight: 500;
        margin-bottom: 0.25rem;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    .session-item .session-time {
        font-size: 0.75rem;
        color: #6c757d;
    }

    .session-item .session-delete {
        position: absolute;
        top: 0.5rem;
        right: 0.5rem;
        opacity: 0;
        transition: opacity 0.2s;
    }

    .session-item:hover .session-delete {
        opacity: 1;
    }

    .chat-messages {
        flex: 1;
        overflow-y: auto;
        padding: 1rem;
        scroll-behavior: smooth;
    }

    .chat-message {
        padding: 1rem;
        margin-bottom: 1rem;
        border-radius: 0.5rem;
    }

    .chat-question {
        background-color: #e3f2fd;
    }

    .chat-answer {
        background-color: #f5f5f5;
    }

    .chat-input-area {
        padding: 1rem;
        border-top: 1px solid #dee2e6;
    }

    .empty-state {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 100%;
        color: #6c757d;
    }
</style>
{% endblock %}

{% block content %}
<div class="chat-container">
    <!-- 左侧：会话管理 -->
    <div class="chat-sidebar">
        <div class="p-3 border-bottom">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h6 class="mb-0"><i class="bi bi-chat-left-text"></i> 聊天会话</h6>
                <button class="btn btn-sm btn-primary" onclick="createNewSession()">
                    <i class="bi bi-plus"></i> 新建
                </button>
            </div>
            <button class="btn btn-sm btn-outline-danger w-100" onclick="clearAllSessions()">
                <i class="bi bi-trash"></i> 清空所有
            </button>
        </div>
        <div class="session-list" id="sessionList">
            <div class="text-center text-muted py-5">
                <i class="bi bi-chat-left-text" style="font-size: 2rem;"></i>
                <p class="mt-2 small">暂无会话</p>
            </div>
        </div>
    </div>

    <!-- 右侧：对话页面 -->
    <div class="chat-main">
        <div class="p-3 border-bottom">
            <div class="d-flex justify-content-between align-items-center">
                <h6 class="mb-0"><i class="bi bi-chat-dots"></i> 对话</h6>
                <select class="form-select form-select-sm" id="kbSelect" style="width: 200px;" onchange="onKbChange()">
                    <option value="">-- 选择知识库 --</option>
                    {% for kb in knowledgebases %}
                    <option value="{{ kb.id }}">{{ kb.name }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>

        <div class="chat-messages" id="chatMessages">
            <div class="empty-state">
                <i class="bi bi-chat-left-text" style="font-size: 3rem;"></i>
                <p class="mt-2">开始提问吧！</p>
            </div>
        </div>

        <div class="chat-input-area">
            <form id="chatForm" onsubmit="askQuestion(event)">
                <div class="mb-2">
                    <textarea oninput="inputChange(event)" class="form-control" id="questionInput" rows="2"
                        placeholder="输入您的问题..." required></textarea>
                </div>
                <div class="d-flex justify-content-end">
                    <button type="submit" class="btn btn-primary" id="submitBtn">
                        <i class="bi bi-send"></i> 发送
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- 删除确认模态窗 -->
<div class="modal fade" id="deleteConfirmModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-exclamation-triangle text-warning"></i> 确认删除</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p id="deleteConfirmMsg">确认删除会话吗？此操作无法撤销。</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteBtn"
                    onclick="confirmDeleteSession()">确认删除</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>

    // 标记渲染任务是否挂起（防止重复）
    let pendingUpdate = false;

    //定时器
    let pendingUpdateTimer = null;
    let deleleteAction = null;
    let deleteSessionId = null;
    let fullAnswer = '';
    let deleteModal = null;

    //当前会话的id,初始为null，当用户点击会话列表时，会更新为当前选中的会话id
    let currentSessionId = null;
    let sessions = [];

    let kb_id = null;

    //让大模型返回的流式答案始终在最底部展示，
    function scrollToBottom() {
        // 获取聊天消息区域元素
        const chatMessages = document.getElementById("chatMessages");

        //设置滚动条位置到最底部
        chatMessages.scrollTop = chatMessages.scrollHeight;

    }


    // 用于格式化时间字符串为友好显示
    function formatTime(timeStr) {
        // 如果无有效时间，直接返回空字符串
        if (!timeStr) return '';
        // 将字符串转换为Date对象
        const date = new Date(timeStr);
        // 获取当前时间
        const now = new Date();
        // 计算时间差（毫秒）
        const diff = now - date;
        // 换算为分钟数
        const minutes = Math.floor(diff / 60000);
        // 换算为小时数
        const hours = Math.floor(diff / 3600000);
        // 换算为天数
        const days = Math.floor(diff / 86400000);
        // 1分钟内显示“刚刚”
        if (minutes < 1) return '刚刚';
        // 1小时内显示“x分钟前”
        if (minutes < 60) return `${minutes}分钟前`;
        // 24小时内显示“x小时前”
        if (hours < 24) return `${hours}小时前`;
        // 7天内显示“x天前”
        if (days < 7) return `${days}天前`;
        // 超过7天显示具体日期
        return date.toLocaleDateString();
    }



    // 为字符串进行HTML转义，防止XSS攻击
    function escapeHtml(text) {
        // 创建一个div元素作为容器
        const div = document.createElement('div');
        // 将待转义文本设置为div的textContent(自动完成转义)
        div.textContent = text;
        // 返回转义后的HTML内容
        return div.innerHTML;
    }

    // 监听输入框内容变化
    function inputChange(event) {
        const questionsInputDom = document.getElementById("questionInput");
        const questions = questionsInputDom.value.trim();
        const submitBtn = document.getElementById("submitBtn");

        // 如果输入框为空，禁用提交按钮
        if (!questions) {
            submitBtn.disabled = true;
        } else {
            submitBtn.disabled = false;
        }
        if (event.key === 'Enter') {
            askQuestion(event);
        }
    }

    // 定义一个用于渲染Markdown文本为HTML的函数
    function renderMarkdown(text) {
        // 判断marked库是否已加载且能使用解析方法
        if (typeof marked !== 'undefined' && marked.parse) {
            try {
                // 尝试用marked库将Markdown文本解析成HTML
                return marked.parse(text);
            } catch (e) {
                // 如果解析出错，则进行HTML转义并换行
                return escapeHtml(text).replace(/\n/g, '<br>');
            }
        }
        // 如果marked库不可用，直接做HTML转义并处理换行
        return escapeHtml(text).replace(/\n/g, '<br>');
    }

    function renderMarkdownToElement(element, text) {
        if (!text) {
            element.innerHTML = `<i class="bi bi-hourglass-spit"></i>思考中...`
        }

        /**
         * 因为大模型返回的内容都是markdown格式的，marked为引入的js脚本，
         * 在base.html引入的https://static.docs-hub.com/markedmin_1767018117982.js
         * 通过mark.parse把markdown格式的字符串直接渲染出来
        */

        element.innerHTML = marked.parse(text)

    }

    // 定义scheduleRender：将markdown渲染插入到队列合适时机执行
    function scheduleRender(answerContent, fullAnswer) {
        // 若当前无待渲染任务才安排渲染
        if (!pendingUpdate) {
            pendingUpdate = true;
            // 下一帧渲染
            requestAnimationFrame(() => {
                // 将答案作为markdown渲染进dom
                renderMarkdownToElement(answerContent, fullAnswer);
                // 清理pending标识
                pendingUpdate = false;
                // 渲染后滚动到底部
                scrollToBottom();
            });
        }
    }

    function clearChatMessages() {
        const chatMessages = document.getElementById("chatMessages")
        chatMessages.innerHTML = `
            <div class="empty-state">
                <i class="bi bi-chat-left-text" style="font-size: 3rem;"></i>
                <p class="mt-2">开始提问吧！</p>
            </div>
        `;
    }

    async function createNewSession(title = "新会话") {
        //从下拉框中获取kb_id
        kb_id = document.getElementById("kbSelect").value;
        const response = await fetch('/chat/createSession', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                kb_id
            }),
        });

        const res = await response.json();
        if (response.ok) {
            if (res.code === 200) {
                currentSessionId = res.data.id;
                //加载会话列表
                await initSessionList();
                //清空聊天消息
                //clearChatMessages();

            }
        } else {
            console.error('创建会话失败:', data.error);
        }
    }



    async function askQuestion(event) {
        event.preventDefault()
        const questionsInputDom = document.getElementById("questionInput");
        const questions = questionsInputDom.value.trim();
        const chatMessages = document.getElementById("chatMessages")

        if (!questions) return;

        //如果当前会话id为空，说明是第一次提问，需要创建新会话
        if (!currentSessionId) {
            await createNewSession();
        }


        if (chatMessages.querySelector('.empty-state')) {
            chatMessages.innerHTML = '';
        }

        const questionDiv = document.createElement("div")
        questionDiv.className = "chat-message chat-question"
        // 构建用户气泡内容含图标、文本和时间
        questionDiv.innerHTML = `
            <div class="d-flex justify-content-between align-items-start">
                <div class="flex-grow-1">
                    <strong><i class="bi bi-person-circle"></i> 问题:</strong>
                    <div class="mt-1">${escapeHtml(questions)}</div>
                </div>
                <small class="text-muted">${new Date().toLocaleTimeString()}</small>
            </div>
        `;
        //把用户提问的问题显示出来
        chatMessages.appendChild(questionDiv);

        //构建显示答案的div
        const answerDivContainer = document.createElement("div");
        answerDivContainer.className = "chat-message chat-answer";

        //显示大模型返回的答案div
        const answerContentId = `answerContent_${Date.now()}_${Math.floor(Math.random() * 100000000)}`;
        const answerContent = document.createElement('div');
        // 为markdown渲染容器设置样式和id
        answerContent.className = 'mt-2 markdown-content';
        answerContent.id = answerContentId;

        answerDivContainer.innerHTML = `
            <div class="d-flex justify-content-between align-items-start">
                <div class="flex-grow-1">
                    <strong><i class="bi bi-robot"></i> 答案:</strong>
                    <!--大模型返回的答案全部append在strong标签的后面-->
                </div>
                <small class="text-muted">${new Date().toLocaleTimeString()}</small>
            </div>
        `;
        const flexGrowDiv = answerDivContainer.querySelector('.flex-grow-1');
        flexGrowDiv.appendChild(answerContent);
        chatMessages.appendChild(answerDivContainer);

        //清空问题
        questionsInputDom.value = ''
        scrollToBottom();
        try {
            const res = await fetch("/chat/llm", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({
                    questions,
                    stream: true, //告诉后端要流式数据
                    session_id: currentSessionId,
                    kb_id: kb_id
                })
            })

            if (!res.ok) throw Error('请求聊天失败')


            //使用ReadableStream  reader获取后端返回的response流
            const reader = res.body.getReader();

            //使用TextDecoder解码服务器返回的二进制数据
            const decoder = new TextDecoder();

            let buffer = '';
            answerContent.innerHTML = '<i class="bi bi-hourglass-split"></i> 思考中...';

            //在大模型返回答案的过程中，实时修改会话标题
            await initSessionList();



            //读取后端通过生成器发送的回来的数据
            while (true) {
                /**
                 * value 是 二进制字节数组=[100, 97, 116, 97, 58, 32, 123, 34, 116, 121, 112, 101, 34, 58, 34, 99, 111, 110, 116, 101, 110, 116, 34, 125, 10, 10]
                */
                const { done, value } = await reader.read();
                if (done) {
                    //后端没有数据，就跳出
                    break;
                }

                //通过TextDecoder将二进制字节数组转换为文本
                buffer += decoder.decode(value, { stream: true })

                //按行进行切分，多行分别处理
                const lines = buffer.split("\n");
                //最后一行一般为残留的数据，等下次数据来再处理
                buffer = lines.pop() || "";


                for (const line of lines) {
                    //如果返回的数据是以data:  开头，则说明这是一个有效的sse(server send event)的数据包
                    if (line.startsWith("data: ")) {
                        const data = line.slice(6);

                        //如果返回的是[DONE]
                        if (data === '[DONE]') {
                            continue;
                        }
                        const chunk = JSON.parse(data);
                        const { type: contentType, content } = chunk;

                        //聊天开始时，要清空内容框
                        if (contentType === "start") {
                            fullAnswer = ''
                            answerContent.innerHTML = '<i class="bi bi-hourglass-split"></i> 思考中...'
                        }
                        else if (contentType === "content") {
                            fullAnswer += content;
                            scheduleRender(answerContent, fullAnswer)
                        }
                        else if (contentType == "done") {
                            renderMarkdownToElement(answerContent, fullAnswer)
                        }
                        else if (contentType == "error") {
                            answerContent.innerHTML += `<div class="alert alert-danger">${content}</div>`;
                        }

                    }
                }

            }

        } catch (error) {
            //请求大模型失败，显示一个默认的div
            answerContent.innerHTML = `
                <div class="alert alert-danger"><strong>错误:</strong>${error.message}</div>
            `;
        }
        finally {
            //请求结束后，清空问题
            //增加修改会话标题
            questionsInputDom.value = ''
            scrollToBottom();
        }
    }

    //渲染左侧的会话列表
    async function renderSessionList() {
        const sessionListDom = document.getElementById("sessionList");
        sessionListDom.innerHTML = '';
        //console.log('sessions=', sessions,'currentSessionId=',currentSessionId);
        if (sessions.length === 0) {
            sessionList.innerHTML = `
            <div class="text-center text-muted py-5">
                <i class="bi bi-chat-left-text" style="font-size: 2rem;"></i>
                <p class="mt-2 small">暂无会话</p>
            </div>
        `;
            return;
        }
        // 遍历sessions并渲染为会话项
        sessionList.innerHTML = sessions.map(session => `
            <div class="session-item ${session.id === currentSessionId ? 'active' : ''}" 
                onclick="loadSession('${session.id}')">
                <button class="btn btn-sm btn-link text-danger p-0 session-delete" 
                        onclick="deleteSession(event)">
                    <i class="bi bi-x-lg" data-session-id="${session.id}"></i>
                </button>
                <div class="session-title">${session.title || '新对话'}</div>
                <div class="session-time">${formatTime(session.updated_at)}</div>
            </div>
        `).join('');
    }


    //删除单个会话
    async function deleteSession(event) {
        event.stopPropagation();
        const sessionId = event.target.getAttribute("data-session-id");
        deleteSessionId = sessionId;
        if (!sessionId) {
            console.error("会话ID不存在,不能删除");
            return;
        }
        deleleteAction = "one";
        deleteModal = new bootstrap.Modal(document.getElementById('deleteConfirmModal'));
        document.getElementById("deleteConfirmMsg").innerHTML = "确认删除会话吗？此操作无法撤销。";
        deleteModal.show();
    }

    //删除所有会话
    async function clearAllSessions() {
        deleleteAction = "all";
        deleteModal = new bootstrap.Modal(document.getElementById('deleteConfirmModal'));
        document.getElementById("deleteConfirmMsg").innerHTML = "确认删除所有会话吗？此操作无法撤销。";
        deleteModal.show();
    }

    async function deleteSessionHandle() {
        if (!deleteSessionId) {
            console.error("会话ID不存在,不能删除");
            return;
        }
        const response = await fetch(`/chat/deleteSession/${deleteSessionId}`, {
            method: "DELETE"
        });
        if (response.ok) {
            const res = await response.json();
            if (res.code === 200) {
                deleteModal && deleteModal.hide();
                if (currentSessionId === deleteSessionId) {
                    //如果当前会话被删除了，清空当前会话id
                    currentSessionId = null;
                }
                deleteSessionId = null;
                clearChatMessages()
                //删除成功后，刷新会话列表
                await initSessionList();
            }
        }
        else {
            console.error("删除会话失败");
        }
    }

    async function deleteAllSessions() {
        const response = await fetch("/chat/deleteAllSessions", {
            method: "DELETE"
        });
        if (response.ok) {
            const res = await response.json();
            if (res.code === 200) {
                const { affected_rows } = res.data || {};
                if (affected_rows > 0) {
                    showToast(`成功删除 ${affected_rows} 个会话`);
                }
                deleteModal && deleteModal.hide();
                //删除成功后，刷新会话列表
                await initSessionList();
            }
        }
        else {
            console.error("删除所有会话失败");
        }
    }


    async function confirmDeleteSession() {
        if (deleleteAction == "one") {
            deleteSessionHandle();
        }
        else if (deleleteAction == "all") {
            deleteAllSessions();
        }
    }

    // 渲染消息
    function renderChatMessages(messages) {
        const chatMessages = document.getElementById('chatMessages');

        if (messages.length === 0) {
            chatMessages.innerHTML = `
                <div class="empty-state">
                    <i class="bi bi-chat-left-text" style="font-size: 3rem;"></i>
                    <p class="mt-2">开始提问吧！</p>
                </div>
            `;
            return;
        }

        chatMessages.innerHTML = messages.map(msg => {
            if (msg.role === 'user') {
                return `
                    <div class="chat-message chat-question">
                        <div class="d-flex justify-content-between align-items-start">
                            <div class="flex-grow-1">
                                <strong><i class="bi bi-person-circle"></i> 问题:</strong>
                                <div class="mt-1">${escapeHtml(msg.content)}</div>
                            </div>
                            <small class="text-muted">${formatTime(msg.created_at)}</small>
                        </div>
                    </div>
                `;
            } else {
                const sourcesHtml = ""; ///generateSourcesHtml(msg.sources, msg.metadata, null);
                return `
                    <div class="chat-message chat-answer">
                        <div class="d-flex justify-content-between align-items-start">
                            <div class="flex-grow-1">
                                <strong><i class="bi bi-robot"></i> 答案:</strong>
                                <div class="mt-2 markdown-content">${renderMarkdown(msg.content)}</div>
                                ${sourcesHtml}
                            </div>
                            <small class="text-muted">${formatTime(msg.created_at)}</small>
                        </div>
                    </div>
                `;
            }
        }).join('');

        scrollToBottom();
    }
    async function loadSession(sessionId) {
        const response = await fetch(`/chat/getSession/${sessionId}`, {
            method: "GET",
        });
        if (response.ok) {
            const res = await response.json();
            const { session, messages } = res.data || {};
            console.log('得到的会话=', session);
            console.log('得到的消息=', messages);
            if (res.code === 200) {
                currentSessionId = session.id || "";
                //await renderSessionList();
                // 调用方法将消息渲染到页面
                renderChatMessages(messages);
                // 重新加载全部会话列表，刷新左侧会话栏
                await initSessionList();
            }
        }
        else {
        }
    }



    async function initSessionList() {
        const kb_id = document.getElementById("kbSelect").value;
        //从数据库中加载会话列表
        const response = await fetch("/chat/initSessionList", {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify({
                kb_id: kb_id || ""
            })
        })
        if (response.ok) {
            const res = await response.json();
            const { data } = res;
            console.log('得到的会话列表=', res.data);
            sessions = data.items || [];
            await renderSessionList();
        }
    }

    document.addEventListener("DOMContentLoaded", async function () {
        // 页面加载完成后，加载会话列表
        await initSessionList();
        if (typeof marked !== 'undefined') {
            // 配置 marked.js 的渲染选项
            marked.setOptions({
                // 启用软换行
                breaks: true,
                // 启用 Github Flavored Markdown
                gfm: true,
                // 禁用标题自动生成 id
                headerIds: false,
                // 禁用混淆处理
                mangle: false
            });
        }
    });

    async function onKbChange() {
        kb_id = document.getElementById("kbSelect").value;
        await initSessionList();
    }



</script>
{% endblock %}